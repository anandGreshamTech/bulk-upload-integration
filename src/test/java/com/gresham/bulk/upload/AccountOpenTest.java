package com.gresham.bulk.upload;

import com.gresham.bulk.upload.service.KubeCommands;
import com.gresham.bulk.upload.service.Loader;
import com.gresham.bulk.upload.service.ResourceReader;
import org.apache.commons.collections4.CollectionUtils;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.LinkedList;
import java.util.List;
import java.util.regex.Pattern;

import static org.junit.jupiter.api.Assertions.assertTrue;

@SpringBootTest
public class AccountOpenTest {

    static String accountOpenDataDir = "src/test/resources/bulkUpload/accountOpen";

    @Autowired
    private KubeCommands kubeCommands;
    @Autowired
    private ResourceReader reader;
    @Autowired
    private Loader loader;

    @Test
    public void testAccountOpen() {
        List<String> actual = new LinkedList<>();
        List<String> expected = new LinkedList<>();
        String drRegex = "(sc\\d+-)|(-sc\\d+)";
        Pattern pattern = Pattern.compile(drRegex);
        List<Path> accountOpenTestScenarios = reader.getDirs(accountOpenDataDir);
        for (Path path : accountOpenTestScenarios) {
            if (!pattern.matcher(path.getFileName().toString()).find()) {
                System.out.println("In progress {" + path.getFileName() + "}");
                List<Path> files = reader.getFiles(path);
                Path testFile = reader.createTestFile(reader.getInputFile(files, "data"));
                System.out.println(testFile.toString());
                Path expectedFile = reader.getInputFile(files, "expected");
                List<String> commsOut = loader.run(kubeCommands.getCommsOutPodCommand(), false);
                loader.run(kubeCommands.getCopyTestFile(testFile), false);
                String rejectFile = testFile.getFileName().toString().replace(".csv", "_REJECT.csv");
                String responseFile = testFile.getFileName().toString().replace(".csv", "_RESPONSE.csv");
//        String rejectFile = "AccountOpen_SMOKESORA_20250325152000_REJECT.csv";
                /*String[] readFileFromConsole = {
                        "/usr/local/bin/kubectl", "exec", "-n", "coil", "-i", "-t",
                        commsOut.get(0),
                        "-c", "comm-anz-out",
                        "--", "sh", "-c", "more ~/output/".concat(rejectFile)
                };*/
                String[] readFileFromConsole = kubeCommands.readFileFromConsole(commsOut.get(0), responseFile);

                if (expectedFile.getFileName().toString().toUpperCase().contains("RESPONSE")) {
                  /*  readFileFromConsole = new String[]{
                            "/usr/local/bin/kubectl", "exec", "-n", "coil", "-i", "-t",
                            commsOut.get(0),
                            "-c", "comm-anz-out",
                            "--", "sh", "-c", "more ~/output/".concat(responseFile)
                    };*/
                    readFileFromConsole = kubeCommands.readFileFromConsole(commsOut.get(0), responseFile);
                    if (kubeCommands.isFileCreated(commsOut.get(0), responseFile)) {
                        actual = loader.run(readFileFromConsole, true);
                    }
                } else {

                    if (kubeCommands.isFileCreated(commsOut.get(0), rejectFile)) {
                        actual = loader.run(readFileFromConsole, true);
                    }

                }
                try {
                    expected = Files.readAllLines(expectedFile);
                } catch (IOException e) {
                    throw new RuntimeException(e);
                }
                System.out.println("{expected}\n :" + expected);
                System.out.println("----------------");
                System.out.println("{actual}\n :" + actual);

                assertTrue(CollectionUtils.isEqualCollection(expected, actual));
                reader.cleanUp(reader.getFiles(path), "AccountOpen_");
            }
        }
    }


}
